{% extends "layout.html" %}

{% block main %}
<div class="flex" id="screen-panel">
    <div class="w-1/8 h-screen items-center justify-center text-center" id="left-panel">
        <div class="h-1/2 text-wrap justify-center flex" id="volume-panel">
            <table class="text-center table-fixed w-full">
                <thead>
                    <tr class="h-12">
                        <th class="w-4/9">Ticker</th>
                        <th class="w-4/9">Volume</th>
                        <th class="w-1/9"></th>
                    </tr>
                </thead>
                <tbody>

                    {% for item in volumeData %}
                        <tr class="border-y border-solid border-collapse border-slate-400 bg-slate-600 hover:bg-slate-700 stock-item">
                            <td class="ticker-code cursor-pointer">
                                {{ item.ticker }}
                            </td>
                            <td>
                                {{ item.volume }}
                            </td>
                            <td>
                                <form action="/favourite" method="get">
                                    <input type="hidden" name="q" value="{{ item.ticker }}">
                                    <svg class="hover:fill-slate-200 cursor-pointer add_favourite" fill="#475569" height="20px" width="20px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 455 455" xml:space="preserve"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g> <polygon points="455,212.5 242.5,212.5 242.5,0 212.5,0 212.5,212.5 0,212.5 0,242.5 212.5,242.5 212.5,455 242.5,455 242.5,242.5 455,242.5 "></polygon> </g></svg> 
                                </form>
                            </td>
                        </tr>
                        
                    {% endfor %}
                </tbody>
            </table>
        </div>
    
        <div class="h-1/2" id="favourites">
            <table class="text-center table-fixed w-full">
                <thead>
                    <tr class="h-12">
                        <th class="w-4/9">Ticker</th>
                        <th class="w-4/9">something</th>
                        <th class="w-1/9"></th>
                    </tr>
                </thead>

                <tbody id="favourite-list">
                    {% for item in favouritesList %}
                    <tr class="border-y h-10 border-solid border-collapse border-slate-400 bg-slate-600 hover:bg-slate-700 stock-item">
                        <td class="ticker-code cursor-pointer">
                            {{ item.ticker }}
                        </td>
                        <td>
                            {{ item.volume }}
                        </td>
                        <td>
                            <form action="/favourite" method="get">
                                <input type="hidden" name="q" value="{{ item.ticker }}">
                                <svg class="cursor-pointer remove_favourite" width="20px" height="20px" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg"><g> <path class="hover:stroke-slate-200" d="M6 12L18 12" stroke="#475569" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
    </div>
    
    <div class="w-5/8 h-screen  text-center" id="main-panel">
            <div class="" id="main-panel-top">
                <div class="flex h-12 w-full">
                    <div class="w-1/2"> </div>
                    <div class="w-1/2 bg-slate-700 flex">
                        <div class="flex w-full justify-end items-center">
                            <a href="/portfolio" class="rounded-lg border w-28 text-center py-1 mx-4 hover:from-cyan-500 hover:bg-linear-to-r to-blue-500 hover:border-0">Portfolio</a>
                            <a href="/account" class="rounded-lg border w-28 text-center py-1 mx-4 hover:from-cyan-500 hover:bg-linear-to-r to-blue-500 hover:border-0">Account</a>
                            <a href="/logout" class="rounded-lg border w-28 text-center py-1 mx-4 hover:from-cyan-500 hover:bg-linear-to-r to-blue-500 hover:border-0">Logout</a>    
                        </div>
                    </div>
                </div>
            </div>
        <div class="size-full" id="main-panel-center">
            <div class="w-full h-12 bg-slate-500 flex justify-evenly relative" id="chart-search-panel">
                <input type="search" class="border-slate-950 border-solid rounded-md border my-1 text-center" autofocus id="search" placeholder="Search code">
                <div class="bg-slate-300 w-2/8 h-auto absolute z-10 top-full" id="search-container">
                    
                    <ul id="search-results">
                        <!-- search results go here -->
                    </ul>
                </div>
            </div>

            <div class="h-5/8 w-full bg-slate-700 flex-col place-items-center" id="main-panel-chart">
                <input type="hidden" id="current-ticker">
                <div id="main-chart" class="w-4/5 h-4/5">
                    <!-- This is where the graph goes -->
                </div>
                <input type="date" class="chartDates border-slate-950 border-solid rounded-md border my-1" placeholder="Date from" id="dateFrom">
                <input type="date" class="chartDates border-slate-950 border-solid rounded-md border my-1" placeholder="Date to" id="dateTo">

            </div>
            <div class="w-full justify-center flex" id="data-container">
                <div class="w-1/2 bg-slate-400 flex justify-center" id="data-left">
                    <table class="table-fixed">
                        <tr>
                            <td>Ticker:</td>
                            <td id="return-ticker"></td>
                        </tr>
                        <tr>
                            <td>Data Timestamp:</td>
                            <td id="return-timestamp"></td>
                        </tr>
                        <tr>
                            <td>Last Price:</td>
                            <td id="return-last"></td>
                        </tr>
                        <tr>
                            <td>Previous Close:</td>
                            <td id="return-prevClose"></td>
                        </tr>
                        <tr>
                            <td>Open Price:</td>
                            <td id="return-open"></td>
                        </tr>
                        <tr>
                            <td>High:</td>
                            <td id="return-high"></td>
                        </tr>
                        <tr>
                            <td>Low:</td>
                            <td id="return-low"></td>
                        </tr>
                        <tr>
                            <td>Mid:</td>
                            <td id="return-mid"></td>
                        </tr>
                        <tr>
                            <td>Volume</td>
                            <td id="return-volume"></td>
                        </tr>
                    </table>
                </div>
                <div class="w-1/2 bg-slate-300" id="data-right">
                    <p>stats from graph go here</p>
                    <p>change in price over month</p>
                    <p>avg open/close?</p>
                </div>
            </div>
        </div>

    </div>
    
    <div class=" w-2/8 h-screen text-center flex justify-between" id="right-panel">
        <table class="table-fixed w-1/2">
            <thead>
                <tr class="h-12">
                    <th class="w-4/9">Ticker</th>
                    <th class="w-4/9">Biggest Gain</th>
                    <th class="w-1/9"></th>
                </tr>
            </thead>
            <tbody>

                {% for item in differenceData %}
                    <tr class="border-y border-solid border-collapse border-slate-400 bg-slate-600 hover:bg-slate-700 stock-item">
                        <td class="ticker-code cursor-pointer">
                            {{ item.ticker }}
                        </td>
                        <td>
                            {{ item.difference }}
                        </td>
                        <td>
                            <form action="/favourite" method="get">
                                <input type="hidden" name="q" value="{{ item.ticker }}">
                                <svg class="hover:fill-slate-200 cursor-pointer add_favourite" fill="#475569" height="20px" width="20px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 455 455" xml:space="preserve"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g> <polygon points="455,212.5 242.5,212.5 242.5,0 212.5,0 212.5,212.5 0,212.5 0,242.5 212.5,242.5 212.5,455 242.5,455 242.5,242.5 455,242.5 "></polygon> </g></svg> 
                            </form>
                        </td>
                    </tr>
                    
                {% endfor %}
            </tbody>
        </table>
        <table class="table-fixed w-1/2">
            <thead>
                <tr class="h-12">
                    <th class="w-4/9">Ticker</th>
                    <th class="w-4/9">Biggest Loss</th>
                    <th class="w-1/9"></th>
                </tr>
            </thead>
            <tbody>

                {% for item in differenceDataReverse %}
                    <tr class="border-y border-solid border-collapse border-slate-400 bg-slate-600 hover:bg-slate-700 stock-item">
                        <td class="ticker-code cursor-pointer">
                            {{ item.ticker }}
                        </td>
                        <td>
                            {{ item.difference }}
                        </td>
                        <td>
                            <form action="/favourite" method="get">
                                <input type="hidden" name="q" value="{{ item.ticker }}">
                                <svg class="hover:fill-slate-200 cursor-pointer add_favourite" fill="#475569" height="20px" width="20px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 455 455" xml:space="preserve"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g> <polygon points="455,212.5 242.5,212.5 242.5,0 212.5,0 212.5,212.5 0,212.5 0,242.5 212.5,242.5 212.5,455 242.5,455 242.5,242.5 455,242.5 "></polygon> </g></svg> 
                            </form>
                        </td>
                    </tr>
                    
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    var stockItems = document.getElementsByClassName("ticker-code");
    let code = document.getElementById("current-ticker").value;
    let dateFrom = document.getElementById("dateFrom").value    
    let dateTo = document.getElementById("dateTo").value
    
    // sets the link aspect of the stock items diplayed on page
    // and updates table & graph when they are clicked
    updatePage(stockItems, dateFrom, dateTo);


    // Run search function on input to the search bar
    let searchForm = document.getElementById("search");
    searchForm.addEventListener('input', function(){
        search(searchForm.value);
    });

    // clear search box when it loses focus
    searchForm.addEventListener('focusout', function(){
        setTimeout(function(){
            document.getElementById("search-results").innerHTML = "";
            document.getElementById("search").value ="";
        }, 75) 
    });


    //updates the graph based on date range changes
    let chartDates = document.getElementsByClassName("chartDates");
    // if dateFrom & dateTo && code all exist, then request chart update with those dates
    for(let i = 0; i < chartDates.length; i++){
        chartDates[i].addEventListener("input", function() {

            // These need to be redeclared here because their values are assigned after
            // the page has loaded
            dateFrom = document.getElementById("dateFrom").value    
            dateTo = document.getElementById("dateTo").value
            code = document.getElementById("current-ticker").value

            if(dateTo && dateFrom && code){
                updateChart(code, dateTo, dateFrom)
            }
        })
    };

    // add item to favourite
    let favouriteButton = document.getElementsByClassName("add_favourite");
    for(let button of favouriteButton){
        button.addEventListener('click', async function(){

            let response = await fetch('/favourite?q=ad&ticker=' + button.previousElementSibling.value)
            updateFavourites()

        });
    };

    // remove item from favourite
    let removeButton = document.getElementsByClassName("remove_favourite");
    for(let button of removeButton){
        button.addEventListener('click', async function(){

            await fetch('/favourite?q=rm&ticker=' + button.previousElementSibling.value)
            updateFavourites()

        });
    };


</script>


{% endblock %}
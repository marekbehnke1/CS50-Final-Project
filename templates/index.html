{% extends "layout.html" %}

{% block main %}
<div class="flex" id="screen-panel">
    <div class="w-1/8 h-screen items-center justify-center text-center" id="left-panel">
        <div class="h-1/2 text-wrap justify-center flex" id="volume-panel">
            <table class="text-center table-fixed w-full">
                <thead>
                    <tr class="h-12">
                        <th class="w-1/2">Ticker</th>
                        <th class="w-1/2">Volume</th>
                    </tr>
                </thead>
                <tbody>

                    {% for item in volumeData %}
                        <tr class="border-y border-solid border-collapse border-slate-400 bg-slate-600 hover:bg-slate-700 stock-item cursor-pointer">
                            <td class="ticker-code">
                                {{ item.ticker }}
                            </td>
                            <td>
                                {{ item.volume }}
                            </td>
                        </tr>
                        
                    {% endfor %}
                </tbody>
            </table>
        </div>
    
        <div class="h-1/2" id="favourites">
            watched stocks
        </div>
    </div>
    
    <div class="w-5/8 h-screen bg-red-200 text-center" id="main-panel">
            <div class="" id="main-panel-top">
                <div class="flex h-12 w-full">
                    <div class="w-1/2 bg-slate-700 flex justify-evenly items-center">

                    </div>
                    <div class="w-1/2 bg-slate-700 flex">
                        <div class="flex w-full justify-end items-center">
                            <a href="/portfolio" class="rounded-lg border w-28 text-center py-1 mx-4 hover:from-cyan-500 hover:bg-linear-to-r to-blue-500 hover:border-0">Portfolio</a>
                            <a href="/account" class="rounded-lg border w-28 text-center py-1 mx-4 hover:from-cyan-500 hover:bg-linear-to-r to-blue-500 hover:border-0">Account</a>
                            <a href="/logout" class="rounded-lg border w-28 text-center py-1 mx-4 hover:from-cyan-500 hover:bg-linear-to-r to-blue-500 hover:border-0">Logout</a>    
                        </div>
                        
                
                    </div>
                </div>
            </div>
        <div class="size-full" id="main-panel-center">
            <div class="w-full h-12 bg-slate-500 flex justify-evenly" id="chart-options-panel">

                <input type="search" class="border-slate-950 border-solid rounded-md border my-1 text-center" autofocus placeholder="Search ticker code" id="search">
            </div>

            <div class="h-5/8 w-full bg-slate-700 flex-col place-items-center" id="main-panel-chart">
                <input type="hidden" id="current-ticker">
                <div id="main-chart" class="w-4/5 h-4/5">
                    <!-- This is where the graph goes -->
                </div>
                <input type="date" class="chartDates border-slate-950 border-solid rounded-md border my-1" placeholder="" id="dateFrom">
                <input type="date" class="chartDates border-slate-950 border-solid rounded-md border my-1" placeholder="" id="dateTo">
            </div>
            <div class="w-full justify-center flex" id="table-container">
                <table class="table-fixed">
                    <tr>
                        <td>Ticker:</td>
                        <td id="return-ticker"></td>
                    </tr>
                    <tr>
                        <td>Data Timestamp:</td>
                        <td id="return-timestamp"></td>
                    </tr>
                    <tr>
                        <td>Last Price:</td>
                        <td id="return-last"></td>
                    </tr>
                    <tr>
                        <td>Previous Close:</td>
                        <td id="return-prevClose"></td>
                    </tr>
                    <tr>
                        <td>Open Price:</td>
                        <td id="return-open"></td>
                    </tr>
                    <tr>
                        <td>High:</td>
                        <td id="return-high"></td>
                    </tr>
                    <tr>
                        <td>Low:</td>
                        <td id="return-low"></td>
                    </tr>
                    <tr>
                        <td>Mid:</td>
                        <td id="return-mid"></td>
                    </tr>
                    <tr>
                        <td>Volume</td>
                        <td id="return-volume"></td>
                    </tr>
                </table>
            </div>
        </div>

    </div>
    
    <div class=" w-2/8 h-screen text-center flex justify-between" id="right-panel">
        <table class="table-fixed w-1/2">
            <thead>
                <tr class="h-12">
                    <th>Ticker</th>
                    <th>Biggest Gain</th>
                </tr>
            </thead>
            <tbody>

                {% for item in differenceData %}
                    <tr class="border-y border-solid border-collapse border-slate-400 bg-slate-600 hover:bg-slate-700 stock-item">
                        <td class="ticker-code cursor-pointer">
                            {{ item.ticker }}
                        </td>
                        <td>
                            {{ item.difference }}
                        </td>
                    </tr>
                    
                {% endfor %}
            </tbody>
        </table>
        <table class="table-fixed w-1/2">
            <thead>
                <tr class="h-12">
                    <th>Ticker</th>
                    <th>Biggest Loss</th>
                </tr>
            </thead>
            <tbody>

                {% for item in differenceDataReverse %}
                    <tr class="border-y border-solid border-collapse border-slate-400 bg-slate-600 hover:bg-slate-700 stock-item">
                        <td class="ticker-code cursor-pointer">
                            {{ item.ticker }}
                        </td>
                        <td>
                            {{ item.difference }}
                        </td>
                    </tr>
                    
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    var stockItems = document.getElementsByClassName("ticker-code");
    let code = document.getElementById("current-ticker").value;
    let dateFrom = document.getElementById("dateFrom").value    
    let dateTo = document.getElementById("dateTo").value

    for(let i = 0; i < stockItems.length; i++){

        stockItems[i].addEventListener("click", async function(){
            // returns the ticker code of the element clicked on
            code = this.textContent.trim();
            document.getElementById("current-ticker").value = code;
            // this sends the code to the /stock route
            let response = await fetch('/stock?q=' + code);

            // this waits for the information to come back, and then treats it as json
            let information = await response.json()

            document.getElementById("return-ticker").innerHTML = information.ticker
            document.getElementById("return-timestamp").innerHTML = information.timestamp
            document.getElementById("return-last").innerHTML = information.tngoLast
            document.getElementById("return-prevClose").innerHTML = information.prevClose
            document.getElementById("return-open").innerHTML = information.open
            document.getElementById("return-high").innerHTML = information.high
            document.getElementById("return-low").innerHTML = information.low
            document.getElementById("return-mid").innerHTML = information.mid
            document.getElementById("return-volume").innerHTML = information.volume
        
            let responseChart = await fetch('/chart?q=' + code)
            let chartData = await responseChart.json()
            
            // TODO: I need to include something to check if dates already exist in here
            dateFrom = document.getElementById("dateFrom").value    
            dateTo = document.getElementById("dateTo").value

            if (dateFrom && dateTo){
                updateChart(code, dateTo, dateFrom)
            }
            else{
                drawChart(chartData, code);
            }
        })
    };


    let chartDates = document.getElementsByClassName("chartDates")
    
    // if dateFrom & dateTo && code all exist, then request chart update with those dates
    for(let i = 0; i < chartDates.length; i++){
        chartDates[i].addEventListener("input", function() {
            
            // These need to be redeclared here because their values are assigned after
            // the page has loaded
            dateFrom = document.getElementById("dateFrom").value    
            dateTo = document.getElementById("dateTo").value
            code = document.getElementById("current-ticker").value

            console.log(code)
            if(dateTo && dateFrom && code){
                console.log("both dates & code exist")

                updateChart(code, dateTo, dateFrom)
            }
            else if(!(code)){
                console.log("code is not set")
            }
            else{
                console.log("both dates are not set")
            };
        })
    };


</script>


{% endblock %}
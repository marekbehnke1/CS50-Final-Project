function drawChart(chartData, code){

    var options = {
        legend: 'none',
        title: code,
        titleTextStyle: {color: 'white'},
        bar: {groupWidth: '100%'},
        candlestick: {
            fallingColor: {stroke: 'white', strokeWidth: 0, fill: '#ec4899'},
            risingColor: {stroke: 'white', strokeWidth: 0, fill: '#0ea5e9'},
        },
        backgroundColor: {fill: '#334155'}, 

        hAxis: {
                gridlines: {color: 'white'},
                minorGridlines: {color: 'white'},
                textStyle: {color: 'white'}
            },

        vAxis: {
                gridlines: {color: 'white'},
                textStyle: {color: 'white'}
            }
    };
    
    var chart = new google.visualization.CandlestickChart(document.getElementById("main-chart"));
    var data = new google.visualization.DataTable(chartData, 0.6);
    chart.draw(data, options);
};

async function updateChart(code, dateTo, dateFrom) {
    let response = await fetch('/chart?q=' + code +'&to=' + dateTo + '&from=' + dateFrom)

    let chartData = await response.json()
    drawChart(chartData, code)
};

async function search(code) {
    // redeclaring this here, becuase new items are generated by this function
    let response = await fetch('/search?q=' + code);
    let searchItems = await response.json();
    
    let html = '';
    
    for (let item of searchItems){
        html += '<li class="search-link border-y border-slate-600 bg-slate-400 hover:bg-slate-600 cursor-pointer">' + item[1] + "</li>";
    } 
    document.getElementById("search-results").innerHTML = html;

    // add event listener to new search box items
    let searchLink = document.getElementsByClassName("search-link")
    for(let link of searchLink){
        link.addEventListener('click', async function () {

            let ticker = link.textContent.trim();
            document.getElementById("current-ticker").value = ticker

            updateTable(ticker)

            dateFrom = document.getElementById("dateFrom").value    
            dateTo = document.getElementById("dateTo").value
            updateChart(ticker, dateTo, dateFrom) 
        })
    }
    
    
};

function updatePage(page_items, dateTo, dateFrom){

    for(let i = 0; i < page_items.length; i++){

        page_items[i].addEventListener("click", async function(){
            // returns the ticker code of the element clicked on
            code = this.textContent.trim();
            document.getElementById("current-ticker").value = code;
            
            updateTable(code);
        
            // have to redeclare these here as their value is assigned after page load
            dateFrom = document.getElementById("dateFrom").value    
            dateTo = document.getElementById("dateTo").value

            updateChart(code, dateTo, dateFrom)
        
        })
    };
};


async function updateTable(code){

    // gets table data
    let response = await fetch('/stock?q=' + code);
    let table_info = await response.json()
    // populates table
    document.getElementById("return-ticker").innerHTML = table_info.ticker
    document.getElementById("return-timestamp").innerHTML = table_info.timestamp
    document.getElementById("return-last").innerHTML = table_info.tngoLast
    document.getElementById("return-prevClose").innerHTML = table_info.prevClose
    document.getElementById("return-open").innerHTML = table_info.open
    document.getElementById("return-high").innerHTML = table_info.high
    document.getElementById("return-low").innerHTML = table_info.low
    document.getElementById("return-mid").innerHTML = table_info.mid
    document.getElementById("return-volume").innerHTML = table_info.volume
};

async function updateFavourites(){
    let response = await fetch('/favourite')
    let result = await response.json()

    let html = ''
    for(let item of result){
        html += '<tr class="border-y border-solid border-collapse border-slate-400 bg-slate-600 hover:bg-slate-700 stock-item"> <td class="ticker-code cursor-pointer">' + item["ticker"] + '</td><td>DATA</td><td><form action="/favourite" method="get"><input type="hidden" name="q" value="' + item["ticker"] + '"></form>ICON</td></tr>'    
    }

    document.getElementById("favourite-list").innerHTML = html
};